<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºé‡‘å®æ—¶ç›‘æ§</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“ˆ åŸºé‡‘å®æ—¶ç›‘æ§</h1>
            <p class="subtitle">è¿½è¸ªåŸºé‡‘æŒä»“è‚¡ç¥¨å®æ—¶èµ°åŠ¿</p>
        </header>

        <!-- æ·»åŠ åŸºé‡‘åŒºåŸŸ -->
        <div class="add-fund-section">
            <div class="input-group">
                <input
                    type="text"
                    id="fundCodeInput"
                    placeholder="è¾“å…¥6ä½åŸºé‡‘ä»£ç ï¼ˆå¦‚ 000001ï¼‰"
                    maxlength="6"
                    onkeypress="if(event.key === 'Enter') addFund()"
                >
                <button onclick="addFund()" class="btn btn-primary">æ·»åŠ åŸºé‡‘</button>
            </div>
        </div>

        <!-- åŸºé‡‘åˆ—è¡¨ -->
        <div class="funds-container" id="fundsContainer">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div class="info-section">
            <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li>è¾“å…¥6ä½åŸºé‡‘ä»£ç ï¼ˆå¦‚ 000001ï¼‰ï¼Œç³»ç»Ÿè‡ªåŠ¨è·å–å‰åå¤§é‡ä»“è‚¡</li>
                <li>ç³»ç»Ÿæ¯5åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°ä¸€æ¬¡æ•°æ®</li>
                <li>ç‚¹å‡»"æŸ¥çœ‹èµ°åŠ¿"å¯æŸ¥çœ‹ä»Šæ—¥åˆ†æ—¶èµ°åŠ¿å›¾</li>
                <li>ç‚¹å‡»"æŸ¥çœ‹æŒä»“"å¯æŸ¥çœ‹å‰åå¤§é‡ä»“è‚¡åˆ—è¡¨</li>
            </ul>
            <p class="note">æ³¨æ„ï¼šæœ¬åº”ç”¨ä»…è®¡ç®—åŸºé‡‘è‚¡ç¥¨éƒ¨åˆ†çš„é¢„ä¼°æ¶¨è·Œå¹…ï¼Œä¸ä»£è¡¨æœ€ç»ˆå‡€å€¼</p>
        </div>
    </div>

    <!-- æŒä»“è¯¦æƒ…å¼¹çª— -->
    <div id="holdingModal" class="modal" onclick="closeModal('holdingModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close" onclick="closeModal('holdingModal')">&times;</span>
            <h2 id="holdingTitle">åŸºé‡‘æŒä»“</h2>
            <div id="holdingList" class="holding-list"></div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶è·å–åŸºé‡‘åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            loadFunds();
            // æ¯60ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
            setInterval(loadFunds, 60000);
        });

        // åŠ è½½åŸºé‡‘åˆ—è¡¨
        async function loadFunds() {
            try {
                const response = await fetch('/api/funds');
                const result = await response.json();

                if (result.success) {
                    renderFunds(result.data);
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error('åŠ è½½åŸºé‡‘åˆ—è¡¨å¤±è´¥:', error);
                showError('åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // æ¸²æŸ“åŸºé‡‘åˆ—è¡¨
        function renderFunds(funds) {
            const container = document.getElementById('fundsContainer');

            if (funds.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>æš‚æ— åŸºé‡‘ç›‘æ§</p>
                        <p class="hint">åœ¨ä¸Šæ–¹è¾“å…¥åŸºé‡‘ä»£ç å¼€å§‹ç›‘æ§</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = funds.map(fund => `
                <div class="fund-card">
                    <div class="fund-header">
                        <div>
                            <h3 class="fund-name">${fund.name}</h3>
                            <p class="fund-code">ä»£ç : ${fund.code}</p>
                        </div>
                        <div class="fund-change ${fund.estimated_change >= 0 ? 'positive' : 'negative'}">
                            ${fund.estimated_change !== null ?
                                (fund.estimated_change >= 0 ? '+' : '') + fund.estimated_change + '%' :
                                'ç­‰å¾…æ•°æ®...'}
                        </div>
                    </div>
                    <div class="fund-actions">
                        <button onclick="viewChart(${fund.id}, '${fund.name}', '${fund.code}')" class="btn btn-secondary">
                            ğŸ“Š æŸ¥çœ‹èµ°åŠ¿
                        </button>
                        <button onclick="viewHoldings(${fund.id}, '${fund.name}')" class="btn btn-secondary">
                            ğŸ“‹ æŸ¥çœ‹æŒä»“
                        </button>
                        <button onclick="deleteFund(${fund.id})" class="btn btn-danger">
                            ğŸ—‘ï¸ åˆ é™¤
                        </button>
                    </div>
                    <p class="last-update">
                        ${fund.last_update ? 'æ›´æ–°: ' + fund.last_update : 'ç­‰å¾…é¦–æ¬¡æ›´æ–°...'}
                    </p>
                </div>
            `).join('');
        }

        // æ·»åŠ åŸºé‡‘
        async function addFund() {
            const input = document.getElementById('fundCodeInput');
            const code = input.value.trim();

            if (!code || code.length !== 6 || !/^\d+$/.test(code)) {
                alert('è¯·è¾“å…¥6ä½æ•°å­—åŸºé‡‘ä»£ç ');
                return;
            }

            try {
                const response = await fetch('/api/funds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: code })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    input.value = '';
                    loadFunds();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('æ·»åŠ åŸºé‡‘å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åˆ é™¤åŸºé‡‘
        async function deleteFund(fundId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåŸºé‡‘å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/funds/${fundId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadFunds();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('åˆ é™¤åŸºé‡‘å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æŸ¥çœ‹æŒä»“è¯¦æƒ…
        async function viewHoldings(fundId, fundName) {
            try {
                const response = await fetch(`/api/funds/${fundId}/holdings`);
                const result = await response.json();

                if (result.success) {
                    document.getElementById('holdingTitle').textContent = `${fundName} - å‰åå¤§é‡ä»“è‚¡`;
                    document.getElementById('holdingList').innerHTML = result.data.map(holding => `
                        <div class="holding-item">
                            <span class="stock-name">${holding.name}</span>
                            <span class="stock-code">${holding.code}</span>
                            <span class="stock-ratio">${holding.ratio}%</span>
                        </div>
                    `).join('');

                    document.getElementById('holdingModal').style.display = 'block';
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('è·å–æŒä»“å¤±è´¥:', error);
                alert('è·å–æŒä»“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æŸ¥çœ‹èµ°åŠ¿å›¾
        async function viewChart(fundId, fundName, fundCode) {
            try {
                const response = await fetch(`/api/funds/${fundId}/history`);
                const result = await response.json();

                if (result.success) {
                    // åˆ›å»ºæˆ–æ›´æ–°å›¾è¡¨çª—å£
                    showChart(result.data, fundName, fundCode);
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('è·å–å†å²æ•°æ®å¤±è´¥:', error);
                alert('è·å–å†å²æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ˜¾ç¤ºå›¾è¡¨çª—å£
        function showChart(data, fundName, fundCode) {
            const chartWindow = window.open('', '_blank', 'width=800,height=600');
            chartWindow.document.write(`
                <!DOCTYPE html>
                <html lang="zh-CN">
                <head>
                    <meta charset="UTF-8">
                    <title>${fundName} - èµ°åŠ¿å›¾</title>
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                            margin: 0;
                            padding: 20px;
                            background: #f5f5f5;
                        }
                        .chart-container {
                            max-width: 900px;
                            margin: 20px auto;
                            background: white;
                            padding: 30px;
                            border-radius: 8px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        }
                        h1 {
                            text-align: center;
                            color: #333;
                            margin-bottom: 30px;
                        }
                        .info {
                            text-align: center;
                            color: #666;
                            margin-bottom: 20px;
                        }
                    </style>
                </head>
                <body>
                    <div class="chart-container">
                        <h1>${fundName} (${fundCode})</h1>
                        <p class="info">ä»Šæ—¥åˆ†æ—¶èµ°åŠ¿å›¾ï¼ˆæ¯5åˆ†é’Ÿæ›´æ–°ï¼‰</p>
                        <canvas id="chart"></canvas>
                    </div>
                    <script>
                        const ctx = document.getElementById('chart').getContext('2d');
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: ${JSON.stringify(data.map(d => d.timestamp))},
                                datasets: [{
                                    label: 'é¢„ä¼°æ¶¨è·Œå¹… (%)',
                                    data: ${JSON.stringify(data.map(d => d.estimated_change))},
                                    borderColor: function(context) {
                                        const chart = context.chart;
                                        const {ctx, chartArea} = chart;
                                        if (!chartArea) return;
                                        const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                                        gradient.addColorStop(0, 'rgba(255, 99, 132, 1)');
                                        gradient.addColorStop(0.5, 'rgba(75, 192, 192, 1)');
                                        gradient.addColorStop(1, 'rgba(54, 162, 235, 1)');
                                        return gradient;
                                    },
                                    backgroundColor: function(context) {
                                        const chart = context.chart;
                                        const {ctx, chartArea} = chart;
                                        if (!chartArea) return;
                                        const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                                        gradient.addColorStop(0, 'rgba(255, 99, 132, 0.1)');
                                        gradient.addColorStop(1, 'rgba(54, 162, 235, 0.1)');
                                        return gradient;
                                    },
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 3,
                                    pointHoverRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false
                                    }
                                },
                                scales: {
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'æ—¶é—´'
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: 'æ¶¨è·Œå¹… (%)'
                                        },
                                        grid: {
                                            color: function(context) {
                                                if (context.tick.value === 0) {
                                                    return '#999';
                                                }
                                                return '#e0e0e0';
                                            },
                                            lineWidth: function(context) {
                                                if (context.tick.value === 0) {
                                                    return 2;
                                                }
                                                return 1;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    </script>
                </body>
                </html>
            `);
            chartWindow.document.close();
        }

        // å…³é—­å¼¹çª—
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const container = document.getElementById('fundsContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
        }
    </script>
</body>
</html>
