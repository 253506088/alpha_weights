# AlphaWeights 项目功能文档

## 1. 项目简介
**AlphaWeights** 是一个基于 **Flask** 和 **Echarts** 的基金实时估值看板系统。
它的核心理念是：**仅通过计算基金前十大重仓股的实时涨跌幅，来预估基金当天的净值变化。**

传统基金APP的估值通常有延迟，或者算法不透明。本系统通过直连交易所实时行情，提供一种透明、可控的“白盒”估值参考。

## 2. 系统核心功能

### 2.1 基金数据管理
- **添加基金**：
  - 在首页顶部输入框输入 **6位数字代码**（如 `000001`）。
  - 系统自动校验代码格式，并通过东方财富接口抓取该基金的**前十大重仓股**及其**持仓占比**。
  - 若代码无效或网络请求失败，会弹出错误提示。
- **删除基金**：
  - 基金卡片右上角设有 **“×”** 删除按钮。
  - 点击后会弹出确认框，确认后删除该基金及其关联的所有历史估值数据。
- **更新持仓**：
  - 基金卡片基金代码旁设有 **“更新持仓”** 按钮。
  - **场景**：当基金季报更新，或用户感觉估值偏差较大时使用。
  - **作用**：强制重新从外部源抓取最新的持仓股票和比例，覆盖现有配置。

### 2.2 实时估值计算
- **计算逻辑**：
  $$ \text{基金预估涨跌幅} = \sum (\text{重仓股实时涨跌幅} \times \text{重仓股占比}) $$
- **局限性**：由于只计算前十大重仓（通常占50%~70%仓位），剩余仓位（债券、现金、其他小票）的波动被忽略，因此估值仅供趋势参考。

### 2.3 自动更新调度
- **定时任务**：
  - 后端基于 `APScheduler` 运行。
  - **默认频率**：60秒/次（用户可配置，最低30秒）。
  - **运行时间窗**：
    - 上午：09:30 ~ 11:30
    - 下午：13:00 ~ 15:00
  - **非交易时间**：任务会自动休眠，避免无效请求。
- **自动补全**：
  - 每天 15:00 之后，系统会自动运行一次，确保记录了当天的收盘数据，方便生成完整的日内曲线。
  - 每天 15:00 之后、早上09:15 时、项目启动时，这三种情况任意一种发生，系统重新获取一下基金的前十大重仓股及其持仓占比。

### 2.4 数据源 (Data Sources)
- **基金持仓**：
  - 来源：东方财富 (EastMoney) PC端接口 `FundArchivesDatas.aspx`
- **股票行情**：
  - 来源：新浪财经 (Sina Finance) `hq.sinajs.cn`
  - 支持市场：沪市 (`sh`)、深市 (`sz`)、北交所 (`bj`)。

## 3. 页面交互与操作细节

### 3.1 顶部操作栏 (Header)
页面顶部包含标题及全局控制按钮：

1.  **系统说明**：
    *   点击标题旁的“系统说明”按钮，弹出帮助模态框。
    *   展示核心原理、数据来源及更新机制的简要说明。
2.  **刷新列表**：
    *   仅重新加载前端显示的基金列表数据（不触发后端重新爬取股票价格）。
    *   用于在多端使用时同步最新状态。
3.  **立即计算**：
    *   **强制触发**后端执行一次全量估值计算任务。
    *   用于在非自动更新周期间隔内想立即看到最新结果时使用。
    *   点击后前端会延迟2秒自动刷新列表以显示最新结果。
4.  **设置**：
    *   打开系统设置弹窗，配置自动更新间隔。
5.  **添加基金输入框**：
    *   支持回车键 (`Enter`) 快速提交。
    *   按钮状态自带 `Loading` 反馈，防止重复提交。

### 3.2 基金概览卡片 (Fund Card)
采用网格布局展示所有监控的基金，每个卡片包含：

-   **基本信息**：
    *   **基金名称**（自动适配长度）。
    *   **基金代码**（带“更新持仓”微型按钮）。
-   **实时估值 (核心指标)**：
    *   大号字体展示预估涨跌幅。
    *   **颜色编码**：
        *   <span style="color: #ef4444">红色</span>：上涨 (Up)
        *   <span style="color: #10b981">绿色</span>：下跌 (Down)
        *   <span style="color: #64748b">灰色</span>：持平 (Neutral)
-   **辅助信息 (Footer)**：
    *   **前十仓位**：显示前十大重仓股占总净值的比例（如 `56.23%`），帮助用户判断估值参考性（比例越高越准）。
    *   **更新时间**：显示该数据最后一次计算的时间点（如 `14:35`）。
-   **交互**：
    *   **点击卡片任意区域**：打开“分时详情”模态框。
    *   **悬停效果**：卡片上浮并出现光晕，增加操作反馈感。

### 3.3 分时详情模态框 (Detail Modal)
点击卡片后全屏弹出的详细分析界面：

-   **左侧：分时走势图**
    *   使用 **Echarts** 绘制的折线图。
    *   横轴：时间（09:30 ~ 15:00）。
    *   纵轴：预估涨跌幅。
    *   **交互**：鼠标悬停在图表上时，会显示对应时间点的详细估值，并**联动更新右侧列表**。
-   **右侧：持仓详情列表**
    *   显示选定时间点（鼠标光标所在时间）的十大重仓股表现。
    *   **列信息**：
        *   **股票**：名称。
        *   **占比**：该股票在基金中的权重。
        *   **涨跌**：该股票当时的实时涨跌幅（红涨绿跌）。
    *   **排序**：默认按持仓占比降序排列。
    *   **动态联动**：当你在左侧图表上拖动鼠标回顾历史走势时，右侧列表会即时变化，还原当时各重仓股的表现，帮助复盘（例如：某时刻基金突然跳水，可立即查看是哪只重仓股砸盘导致）。

### 3.4 系统设置模态框
-   **自动更新间隔**：
    *   输入数字设置后端轮询频率。
    *   **单位**：秒。
    *   **限制**：最小 **30秒**。
    *   **生效机制**：点击保存后，后端定时任务会立即重启并应用新频率。

## 4. 技术细节

### 4.1 目录结构
```text
alpha_weights/
├── app.py                  # Flask Web入口，API路由
├── scheduler_service.py    # 定时任务调度逻辑
├── fetcher.py             # 爬虫模块 (FundFetcher, StockFetcher)
├── models.py              # 数据库模型 (SQLAlchemy + SQLite)
├── log_utils.py           # 日志工具 (带时间戳)
├── templates/
│   └── index.html         # 前端单页应用 (Vue + Echarts)
└── data/
    └── fund_monitor.db    # SQLite 数据文件
```

### 4.2 数据库表设计
- **funds**: 基础信息。
- **stocks**: 股票池。
- **holdings**: 关联表 (Fund -> Stock)，存储 `ratio`。
- **fund_histories**: 分钟级估值历史，用于画图。
- **stock_prices**: 分钟级股价历史，用于详情页的“历史回溯”。
- **system_config**: 全局配置。

### 4.3 API 接口列表

| 方法 | 路径 | 功能 | 参数示例 |
| :--- | :--- | :--- | :--- |
| `GET` | `/api/fund/list` | 首页数据 | 无 |
| `POST` | `/api/fund/add` | 添加基金 | `{code: "110011"}` |
| `POST` | `/api/fund/delete` | 删除基金 | `{id: 1}` |
| `POST` | `/api/fund/refresh_holdings` | 更新持仓 | `{id: 1}` |
| `GET` | `/api/fund/history/<id>` | 详情页数据 | 无 |
| `POST` | `/api/config/update` | 修改配置 | `{interval: 60}` |
| `POST` | `/api/trigger` | 强制计算 | 无 |

## 5. 部署说明
- **环境**：Python 3.8+, `pip install -r requirements.txt`。
- **启动**：运行 `python app.py`。
- **访问**：浏览器打开 `http://localhost:5000`。
