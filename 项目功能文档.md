# AlphaWeights 项目功能文档

## 1. 项目简介
**AlphaWeights** 是一个基于 **Flask** 和 **Echarts** 的基金实时估值看板系统。
它的核心理念是：**仅通过计算基金前十大重仓股的实时涨跌幅，来预估基金当天的净值变化。**

传统基金APP的估值通常有延迟，或者算法不透明。本系统通过直连交易所实时行情，提供一种透明、可控的“白盒”估值参考。

## 2. 核心功能

### 2.1 基金数据管理
- **添加基金**：用户输入6位基金代码（如 `000001`），系统通过东方财富接口抓取该基金的**前十大重仓股**及其**持仓占比**。
- **删除基金**：删除不再关注的基金，同时清理关联的历史数据。
- **更新持仓**：随着季报更新，持仓结构会变化。支持一键“更新持仓”，重新从外部源抓取最新的季度持仓数据。

### 2.2 实时估值计算
- **计算逻辑**：
  $$ \text{基金预估涨跌幅} = \sum (\text{重仓股实时涨跌幅} \times \text{重仓股占比}) $$
- **局限性**：由于只计算前十大重仓（通常占50%~70%仓位），剩余仓位（债券、现金、其他小票）的波动被忽略，因此估值仅供趋势参考。

### 2.3 自动更新调度
- **定时任务**：
  - 后端基于 `APScheduler` 运行。
  - **默认频率**：60秒/次（可配置，最低30秒）。
  - **运行时间窗**：
    - 上午：09:30 ~ 11:30
    - 下午：13:00 ~ 15:00
  - **非交易时间**：任务会自动休眠，避免无效请求。
- **收盘补全**：
  - 每天 15:00 之后，系统会自动运行一次，确保记录了当天的收盘数据，方便生成完整的日内曲线。

### 2.4 数据源 (Data Sources)
- **基金持仓**：
  - 来源：东方财富 (EastMoney) PC端接口 `FundArchivesDatas.aspx`
  - 频率：添加基金或手动点击“更新持仓”时触发。
- **股票行情**：
  - 来源：新浪财经 (Sina Finance) `hq.sinajs.cn`
  - 频率：定时任务周期性触发（默认60秒）。
  - 支持市场：沪市 (`sh`)、深市 (`sz`)、北交所 (`bj`)。

## 3. 技术细节

### 3.1 目录结构
```text
alpha_weights/
├── app.py                  # Flask Web入口，API路由
├── scheduler_service.py    # 定时任务调度逻辑
├── fetcher.py             # 爬虫模块 (FundFetcher, StockFetcher)
├── models.py              # 数据库模型 (SQLAlchemy + SQLite)
├── log_utils.py           # 日志工具 (带时间戳)
├── templates/
│   └── index.html         # 前端单页应用 (Vue + Echarts)
└── data/
    └── fund_monitor.db    # SQLite 数据文件
```

### 3.2 数据库设计 (`fund_monitor.db`)
- **funds**: 存储基金基础信息（代码、名称）。
- **stocks**: 存储涉及到的股票池（去重）。
- **holdings**: 基金与股票的关联表，记录权重 (`ratio`)。
- **fund_histories**: 基金的分钟级估值历史（用于画分时图）。
- **stock_prices**: 股票的分钟级价格历史。
- **system_config**: 存储系统全局配置（如更新间隔）。

### 3.3 API 接口说明

| 方法 | 路径 | 描述 |
| :--- | :--- | :--- |
| `GET` | `/api/fund/list` | 获取首页基金列表（含最新预估值） |
| `POST` | `/api/fund/add` | 添加新基金 `{code: "..."}` |
| `POST` | `/api/fund/delete` | 删除基金 `{id: ...}` |
| `POST` | `/api/fund/refresh_holdings` | 强制刷新持仓 `{id: ...}` |
| `GET` | `/api/fund/history/<id>` | 获取某基金的日内分时估值数据 |
| `GET` | `/api/config` | 获取系统配置 |
| `POST` | `/api/config/update` | 更新配置（如修改刷新频率） |

## 4. 前端交互
- **UI框架**：原生 HTML/CSS + Vue.js (CDN版)。
- **图表**：使用 Echarts 渲染基金的日内实时走势图。
- **主题风格**："Neo-Brutalism" 结合 "Starry Night" 暗黑风格。
  - 动态背景光晕。
  - 使用 Inter 字体。
  - 涨跌色：红涨绿跌。
- **设置面板**：允许用户在界面上动态调整后端的轮询间隔（秒）。

## 5. 部署与运行
- **环境依赖**：Python 3.8+, `flask`, `apscheduler`, `sqlalchemy`, `requests`, `lxml`。
- **启动方式**：执行 `python app.py`。
- **访问地址**：`http://localhost:5000`。
- **日志**：控制台标准输出，格式为 `【YYYY-MM-DD HH:mm:ss.SSS  消息内容】`。
